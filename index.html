<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jim Tracker</title>
    <meta name="theme-color" content="#1f2937">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            min-height: 100vh;
            padding: 15px;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 20px;
        }

        .week-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .workout-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
        }

        .hidden {
            display: none !important;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .action-btn.success {
            border-color: #10b981;
            color: #6ee7b7;
        }

        .action-btn.danger {
            border-color: #ef4444;
            color: #fecaca;
        }

        .action-btn.primary {
            border-color: #3b82f6;
            color: #93c5fd;
        }

        .exercise-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 16px;
            width: 100%;
        }

        .exercise-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .muscle-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 16px;
            width: 100%;
        }

        .muscle-select option {
            background: #374151;
            color: white;
        }

        .exercise-row {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-exercise-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-container {
            position: relative;
        }

        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(31, 41, 55, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin-top: 2px;
        }

        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background: rgba(16, 185, 129, 0.2);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: #10b981;
            font-size: 14px;
        }

        .suggestion-details {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-muscle {
            color: #60a5fa;
            font-weight: 500;
        }

        .suggestion-difficulty {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
        }

        .suggestion-equipment {
            margin-top: 2px;
            font-size: 11px;
            opacity: 0.6;
        }

        .no-results {
            padding: 12px;
            text-align: center;
            opacity: 0.6;
            font-style: italic;
        }

        .search-hint {
            padding: 8px 12px;
            background: rgba(16, 185, 129, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px;
            opacity: 0.8;
            text-align: center;
        }

        .exercise {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .exercise-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #10b981;
        }

        .set {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .set-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            width: 100%;
        }

        .loading {
            padding: 12px;
            text-align: center;
            opacity: 0.6;
            font-style: italic;
        }

        @media (max-width: 480px) {
            .nav-buttons {
                flex-direction: column;
            }
            .nav-btn {
                width: 100%;
            }
            .add-exercise-row {
                grid-template-columns: 1fr;
            }
            .suggestions-dropdown {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💪 Jim Tracker</h1>
        </div>

        <div class="week-info">
            <div id="todayInfo"></div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div style="margin-bottom: 8px; font-weight: 500;">Did you go to the gym today?</div>
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button class="action-btn success" onclick="markAttendance(true)" id="yesBtn">✓ Yes</button>
                    <button class="action-btn" onclick="markAttendance(false)">Reset</button>
                </div>
                <div id="attendanceStatus" style="margin-top: 8px; font-size: 0.9rem; opacity: 0.8;"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" data-section="workout">Today's Workout</button>
            <button class="nav-btn" data-section="workouts">Workouts</button>
            <button class="nav-btn" data-section="progress">Progress</button>
            <button class="nav-btn" data-section="history">History</button>
            <button class="nav-btn" data-section="settings">Settings</button>
        </div>

        <div id="workoutSection">
            <div id="todayWorkout"></div>
        </div>

        <div id="workoutsSection" class="hidden">
            <div class="workout-card">
                <h2>Workouts</h2>
                <button class="action-btn success" onclick="showWorkoutForm()">+ Create New Workout</button>
                
                <div id="workoutForm" class="hidden" style="margin-top: 20px;">
                    <h3 id="formTitle" style="color: #10b981;">Create New Workout</h3>
                    <input type="text" id="workoutName" placeholder="Workout name" class="exercise-input" style="margin: 15px 0;">
                    <div id="exercisesList"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="action-btn" onclick="addExerciseRow()">+ Add Exercise</button>
                        <button class="action-btn success" onclick="saveWorkout()">Save</button>
                        <button class="action-btn" onclick="hideWorkoutForm()">Cancel</button>
                    </div>
                </div>
                
                <div id="workoutsList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="progressSection" class="hidden">
            <div class="workout-card">
                <h2>Progress</h2>
                <p>Track your progress over time</p>
            </div>
        </div>

        <div id="historySection" class="hidden">
            <div class="workout-card">
                <h2>History</h2>
                <div id="historyContent"></div>
            </div>
        </div>

        <div id="settingsSection" class="hidden">
            <div class="workout-card">
                <h2>Settings</h2>
                <div id="settingsContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Global data
        let appData = {
            workouts: {},
            history: {},
            active: {},
            attendance: {},
            settings: {}
        };
        
        let exerciseDB = {};
        let equipmentDB = [];
        let editingWorkoutId = null;
        let githubConfig = {};
        let currentHighlightedIndex = -1;

        // Initialize
        async function init() {
            await loadDatabases();
            loadLocalData();
            setupNav();
            updateToday();
            showTodayWorkout();
        }

        // Load from GitHub with enhanced error handling
        async function loadDatabases() {
            // Try GitHub Pages URL first, then fallback to raw GitHub
            const GITHUB_PAGES_URL = 'https://cjwiebe.github.io/Jim-Tracker/';
            const RAW_GITHUB_URL = 'https://raw.githubusercontent.com/CJWiebe/Jim-Tracker/main/';
            
            // Load exercises database
            let exerciseLoaded = false;
            for (const baseUrl of [GITHUB_PAGES_URL, RAW_GITHUB_URL]) {
                if (exerciseLoaded) break;
                
                try {
                    console.log(`🔄 Loading exercise database from: ${baseUrl}`);
                    const exRes = await fetch(baseUrl + 'exercises.json', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (exRes.ok) {
                        const text = await exRes.text();
                        console.log('📄 Raw exercises response length:', text.length);
                        exerciseDB = JSON.parse(text);
                        console.log('✅ Successfully loaded', Object.keys(exerciseDB).length, 'exercises from', baseUrl);
                        
                        // Log first few exercise names to verify
                        const firstFew = Object.keys(exerciseDB).slice(0, 3);
                        console.log('🏋️ Sample exercises:', firstFew.join(', '));
                        exerciseLoaded = true;
                    } else {
                        console.warn(`❌ HTTP ${exRes.status} from ${baseUrl}`);
                    }
                } catch (e) {
                    console.warn(`❌ Failed to load from ${baseUrl}:`, e.message);
                }
            }
            
            if (!exerciseLoaded) {
                console.log('🔄 Using fallback exercise database...');
                exerciseDB = createFallbackExerciseDB();
            }

            // Load equipment database
            let equipmentLoaded = false;
            for (const baseUrl of [GITHUB_PAGES_URL, RAW_GITHUB_URL]) {
                if (equipmentLoaded) break;
                
                try {
                    console.log(`🔄 Loading equipment database from: ${baseUrl}`);
                    const eqRes = await fetch(baseUrl + 'equipment.json', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (eqRes.ok) {
                        const text = await eqRes.text();
                        console.log('📄 Raw equipment response length:', text.length);
                        const data = JSON.parse(text);
                        equipmentDB = extractEquipmentNames(data);
                        console.log('✅ Successfully loaded', equipmentDB.length, 'equipment items from', baseUrl);
                        
                        // Log first few equipment names to verify
                        const firstFew = equipmentDB.slice(0, 5);
                        console.log('⚙️ Sample equipment:', firstFew.join(', '));
                        equipmentLoaded = true;
                    } else {
                        console.warn(`❌ HTTP ${eqRes.status} from ${baseUrl}`);
                    }
                } catch (e) {
                    console.warn(`❌ Failed to load from ${baseUrl}:`, e.message);
                }
            }
            
            if (!equipmentLoaded) {
                console.log('🔄 Using fallback equipment database...');
                equipmentDB = createFallbackEquipmentDB();
            }
            
            // Final verification
            console.log('🎯 Database loading complete:');
            console.log(`   - Exercises: ${Object.keys(exerciseDB).length}`);
            console.log(`   - Equipment: ${equipmentDB.length}`);
        }

        function createFallbackExerciseDB() {
            return {
                'Bench Press': { 
                    muscleGroup: 'Chest', 
                    equipment: 'Olympic barbell, flat bench with rack, weight plates',
                    difficulty: 'beginner',
                    isBodyweight: false
                },
                'Squats': { 
                    muscleGroup: 'Quads', 
                    equipment: 'Olympic barbell, squat rack with safety bars, weight plates',
                    difficulty: 'intermediate',
                    isBodyweight: false
                },
                'Deadlifts': { 
                    muscleGroup: 'Back', 
                    equipment: 'Olympic barbell, weight plates, collars',
                    difficulty: 'advanced',
                    isBodyweight: false
                },
                'Pull-ups': { 
                    muscleGroup: 'Back', 
                    equipment: 'Pull-up bar (fixed or adjustable)',
                    difficulty: 'intermediate',
                    isBodyweight: true
                },
                'Push-ups': { 
                    muscleGroup: 'Chest', 
                    equipment: 'None (floor/mat optional)',
                    difficulty: 'beginner',
                    isBodyweight: true
                },
                'Dips': { 
                    muscleGroup: 'Triceps', 
                    equipment: 'Parallel dip bars or dip station',
                    difficulty: 'intermediate',
                    isBodyweight: true
                },
                'Overhead Press': { 
                    muscleGroup: 'Shoulders', 
                    equipment: 'Olympic barbell, squat rack with safety bars',
                    difficulty: 'intermediate',
                    isBodyweight: false
                },
                'Barbell Rows': { 
                    muscleGroup: 'Back', 
                    equipment: 'Olympic barbell (45 lbs), weight plates, collars',
                    difficulty: 'intermediate',
                    isBodyweight: false
                },
                'Barbell Curls': { 
                    muscleGroup: 'Biceps', 
                    equipment: 'Olympic barbell, weight plates',
                    difficulty: 'beginner',
                    isBodyweight: false
                },
                'Planks': { 
                    muscleGroup: 'Core', 
                    equipment: 'Exercise mat recommended',
                    difficulty: 'beginner',
                    isBodyweight: true
                }
            };
        }

        function createFallbackEquipmentDB() {
            return [
                'Olympic Barbell', 'Dumbbells', 'Flat Bench', 'Squat Rack', 'Pull-up Bar',
                'Dip Station', 'Cable Machine', 'Weight Plates', 'Exercise Mat', 'Kettlebells',
                'Resistance Bands', 'Medicine Ball', 'Ab Wheel', 'Incline Bench', 'Leg Press Machine'
            ];
        }

        function extractEquipmentNames(data) {
            const names = [];
            Object.values(data).forEach(category => {
                if (typeof category === 'object') {
                    Object.values(category).forEach(item => {
                        if (item && item.name) {
                            names.push(item.name);
                        }
                    });
                }
            });
            return [...new Set(names)]; // Remove duplicates
        }

        function loadLocalData() {
            const saved = localStorage.getItem('jimTrackerData');
            if (saved) {
                appData = JSON.parse(saved);
            }
            
            const ghSaved = localStorage.getItem('jimTrackerGH');
            if (ghSaved) {
                githubConfig = JSON.parse(ghSaved);
            }
            
            // Add sample workouts if none exist
            if (!appData.workouts || Object.keys(appData.workouts).length === 0) {
                appData.workouts = {
                    's1': {
                        name: 'Push Day',
                        exercises: [
                            { name: 'Bench Press', muscle: 'Chest', equipment: 'Barbell, Bench' },
                            { name: 'Overhead Press', muscle: 'Shoulders', equipment: 'Barbell' },
                            { name: 'Dips', muscle: 'Triceps', equipment: 'Dip bars' }
                        ]
                    },
                    's2': {
                        name: 'Pull Day',
                        exercises: [
                            { name: 'Pull-ups', muscle: 'Back', equipment: 'Pull-up bar' },
                            { name: 'Barbell Rows', muscle: 'Back', equipment: 'Barbell' },
                            { name: 'Barbell Curls', muscle: 'Biceps', equipment: 'Barbell' }
                        ]
                    }
                };
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('jimTrackerData', JSON.stringify(appData));
        }

        function setupNav() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.dataset.section;
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('[id$="Section"]').forEach(s => s.classList.add('hidden'));
                    document.getElementById(section + 'Section').classList.remove('hidden');
                    
                    if (section === 'workouts') showWorkoutsList();
                    if (section === 'history') showHistory();
                    if (section === 'settings') showSettings();
                });
            });
        }

        function updateToday() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', {
                weekday: 'long', month: 'long', day: 'numeric'
            });
            document.getElementById('todayInfo').textContent = `Today is ${dateStr}`;
            
            // Check attendance
            const todayKey = today.toDateString();
            if (appData.attendance && appData.attendance[todayKey]) {
                document.getElementById('attendanceStatus').textContent = '✅ Yes, I went to the gym today!';
                document.getElementById('attendanceStatus').style.color = '#10b981';
                document.getElementById('yesBtn').style.background = 'linear-gradient(45deg, #10b981, #059669)';
            } else {
                document.getElementById('attendanceStatus').textContent = 'Mark if you went to the gym today';
                document.getElementById('attendanceStatus').style.color = '';
                document.getElementById('yesBtn').style.background = '';
            }
        }

        function markAttendance(went) {
            const today = new Date().toDateString();
            if (!appData.attendance) appData.attendance = {};
            
            if (went) {
                appData.attendance[today] = true;
            } else {
                delete appData.attendance[today];
            }
            
            saveData();
            updateToday();
        }

        function showTodayWorkout() {
            const container = document.getElementById('todayWorkout');
            const today = new Date().toDateString();
            
            if (appData.active && appData.active[today]) {
                showActiveWorkout(today);
                return;
            }
            
            let html = '<div class="workout-card"><h2>Select Workout</h2>';
            Object.entries(appData.workouts || {}).forEach(([id, w]) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin: 10px 0; cursor: pointer;"
                         onclick="startWorkout('${id}')">
                        <div>
                            <div style="font-weight: 600; color: #10b981;">${w.name}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">${w.exercises.length} exercises</div>
                        </div>
                        <div>▶</div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function startWorkout(id) {
            const workout = appData.workouts[id];
            const today = new Date().toDateString();
            
            if (!appData.active) appData.active = {};
            appData.active[today] = {
                workoutId: id,
                name: workout.name,
                exercises: workout.exercises.map(e => ({
                    ...e,
                    sets: [
                        { weight: '', reps: '' },
                        { weight: '', reps: '' },
                        { weight: '', reps: '' },
                        { weight: '', reps: '' }
                    ]
                }))
            };
            
            saveData();
            showActiveWorkout(today);
        }

        function showActiveWorkout(key) {
            const w = appData.active[key];
            let html = `
                <div class="workout-card">
                    <h2>${w.name}</h2>
                    <div style="margin: 15px 0;">
                        <button class="action-btn" onclick="cancelWorkout('${key}')">Cancel</button>
                        <button class="action-btn success" onclick="finishWorkout('${key}')">Complete</button>
                    </div>
            `;
            
            w.exercises.forEach((ex, i) => {
                html += `
                    <div class="exercise">
                        <div class="exercise-name">${ex.name}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">
                            ${ex.muscle} • ${ex.equipment || 'No equipment'}
                        </div>
                `;
                
                ex.sets.forEach((set, j) => {
                    html += `
                        <div class="set">
                            <div style="color: #60a5fa;">Set ${j+1}</div>
                            <input type="number" class="set-input" placeholder="Weight" value="${set.weight}"
                                   onchange="updateSet('${key}',${i},${j},'weight',this.value)">
                            <input type="number" class="set-input" placeholder="Reps" value="${set.reps}"
                                   onchange="updateSet('${key}',${i},${j},'reps',this.value)">
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            document.getElementById('todayWorkout').innerHTML = html;
        }

        function updateSet(key, exIdx, setIdx, field, value) {
            appData.active[key].exercises[exIdx].sets[setIdx][field] = value;
            saveData();
        }

        function cancelWorkout(key) {
            if (confirm('Cancel workout?')) {
                delete appData.active[key];
                saveData();
                showTodayWorkout();
            }
        }

        function finishWorkout(key) {
            if (!appData.history) appData.history = {};
            const timestamp = new Date().toISOString();
            appData.history[timestamp] = {
                ...appData.active[key],
                completed: timestamp,
                bodyWeight: appData.settings?.bodyWeight
            };
            delete appData.active[key];
            saveData();
            alert('Workout completed!');
            showTodayWorkout();
        }

        // Enhanced Workout Management
        function showWorkoutForm(id = null) {
            editingWorkoutId = id;
            const form = document.getElementById('workoutForm');
            form.classList.remove('hidden');
            
            if (id) {
                document.getElementById('formTitle').textContent = 'Edit Workout';
                const w = appData.workouts[id];
                document.getElementById('workoutName').value = w.name;
                
                const list = document.getElementById('exercisesList');
                list.innerHTML = '';
                w.exercises.forEach(ex => {
                    addExerciseRow(ex);
                });
            } else {
                document.getElementById('formTitle').textContent = 'Create New Workout';
                document.getElementById('workoutName').value = '';
                document.getElementById('exercisesList').innerHTML = '';
                addExerciseRow();
            }
        }

        function hideWorkoutForm() {
            document.getElementById('workoutForm').classList.add('hidden');
            editingWorkoutId = null;
        }

        function addExerciseRow(data = null) {
            const container = document.getElementById('exercisesList');
            const row = document.createElement('div');
            row.className = 'exercise-row';
            
            row.innerHTML = `
                <div class="add-exercise-row">
                    <div class="input-container">
                        <input type="text" placeholder="Search exercises..." class="exercise-input ex-name"
                               value="${data?.name || ''}" 
                               oninput="showExerciseSuggestions(this)" 
                               onkeydown="handleSuggestionKeydown(event, this)"
                               onfocus="showExerciseSuggestions(this)">
                        <div class="suggestions-dropdown hidden"></div>
                    </div>
                    <select class="muscle-select">
                        <option value="">Muscle...</option>
                        <option value="Back" ${data?.muscle === 'Back' ? 'selected' : ''}>Back</option>
                        <option value="Chest" ${data?.muscle === 'Chest' ? 'selected' : ''}>Chest</option>
                        <option value="Shoulders" ${data?.muscle === 'Shoulders' ? 'selected' : ''}>Shoulders</option>
                        <option value="Triceps" ${data?.muscle === 'Triceps' ? 'selected' : ''}>Triceps</option>
                        <option value="Biceps" ${data?.muscle === 'Biceps' ? 'selected' : ''}>Biceps</option>
                        <option value="Quads" ${data?.muscle === 'Quads' ? 'selected' : ''}>Quads</option>
                        <option value="Hamstrings" ${data?.muscle === 'Hamstrings' ? 'selected' : ''}>Hamstrings</option>
                        <option value="Glutes" ${data?.muscle === 'Glutes' ? 'selected' : ''}>Glutes</option>
                        <option value="Calves" ${data?.muscle === 'Calves' ? 'selected' : ''}>Calves</option>
                        <option value="Rear Delts" ${data?.muscle === 'Rear Delts' ? 'selected' : ''}>Rear Delts</option>
                        <option value="Core" ${data?.muscle === 'Core' ? 'selected' : ''}>Core</option>
                        <option value="Other" ${data?.muscle === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                </div>
                <div class="input-container">
                    <input type="text" placeholder="Equipment needed..." class="exercise-input eq-name"
                           value="${data?.equipment || ''}" 
                           oninput="showEquipmentSuggestions(this)"
                           onkeydown="handleSuggestionKeydown(event, this)"
                           onfocus="showEquipmentSuggestions(this)">
                    <div class="suggestions-dropdown hidden"></div>
                </div>
                <button class="action-btn danger" onclick="this.parentElement.remove()" style="margin-top: 10px;">Remove</button>
            `;
            
            container.appendChild(row);
        }

        // Enhanced Exercise Search
        function showExerciseSuggestions(input) {
            const query = input.value.toLowerCase().trim();
            const dropdown = input.nextElementSibling;
            
            if (query.length < 2) {
                dropdown.classList.add('hidden');
                currentHighlightedIndex = -1;
                return;
            }
            
            const matches = searchExercises(query);
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No exercises found matching "' + input.value + '"</div>';
                dropdown.classList.remove('hidden');
                currentHighlightedIndex = -1;
                return;
            }
            
            let html = '<div class="search-hint">Found ' + matches.length + ' exercises • Use ↑↓ keys to navigate</div>';
            
            matches.forEach((exercise, index) => {
                const data = exerciseDB[exercise];
                const difficultyColor = getDifficultyColor(data.difficulty);
                
                html += `
                    <div class="suggestion-item" data-exercise="${exercise}" data-index="${index}"
                         onclick="selectExercise(this, '${exercise}')">
                        <div class="suggestion-name">${exercise}</div>
                        <div class="suggestion-details">
                            <span class="suggestion-muscle">${data.muscleGroup}</span>
                            <span class="suggestion-difficulty" style="background: ${difficultyColor};">
                                ${data.difficulty || 'N/A'}
                            </span>
                        </div>
                        <div class="suggestion-equipment">${data.equipment || 'No equipment specified'}</div>
                        ${data.isBodyweight ? '<div style="margin-top: 2px; font-size: 10px; color: #10b981;">✓ Bodyweight</div>' : ''}
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
            currentHighlightedIndex = -1;
        }

        function searchExercises(query) {
            const exercises = Object.keys(exerciseDB);
            
            // Exact matches first
            const exactMatches = exercises.filter(name => 
                name.toLowerCase() === query
            );
            
            // Starts with matches
            const startsWithMatches = exercises.filter(name => 
                name.toLowerCase().startsWith(query) && !exactMatches.includes(name)
            );
            
            // Contains matches
            const containsMatches = exercises.filter(name => {
                const lowerName = name.toLowerCase();
                return lowerName.includes(query) && 
                       !exactMatches.includes(name) && 
                       !startsWithMatches.includes(name);
            });
            
            // Muscle group matches
            const muscleMatches = exercises.filter(name => {
                const data = exerciseDB[name];
                return data.muscleGroup && 
                       data.muscleGroup.toLowerCase().includes(query) &&
                       !exactMatches.includes(name) && 
                       !startsWithMatches.includes(name) &&
                       !containsMatches.includes(name);
            });
            
            // Alternative names matches
            const altNameMatches = exercises.filter(name => {
                const data = exerciseDB[name];
                if (!data.alternativeNames) return false;
                
                return data.alternativeNames.some(alt => 
                    alt.toLowerCase().includes(query)
                ) && 
                !exactMatches.includes(name) && 
                !startsWithMatches.includes(name) &&
                !containsMatches.includes(name) &&
                !muscleMatches.includes(name);
            });
            
            return [
                ...exactMatches,
                ...startsWithMatches,
                ...containsMatches,
                ...muscleMatches,
                ...altNameMatches
            ].slice(0, 10);
        }

        function getDifficultyColor(difficulty) {
            switch(difficulty?.toLowerCase()) {
                case 'beginner': return 'rgba(16, 185, 129, 0.3)';
                case 'intermediate': return 'rgba(245, 158, 11, 0.3)';
                case 'advanced': return 'rgba(239, 68, 68, 0.3)';
                default: return 'rgba(255, 255, 255, 0.1)';
            }
        }

        function selectExercise(element, exerciseName) {
            const row = element.closest('.exercise-row');
            const data = exerciseDB[exerciseName];
            
            // Fill in exercise name
            const nameInput = row.querySelector('.ex-name');
            nameInput.value = exerciseName;
            
            // Auto-fill muscle group
            const muscleSelect = row.querySelector('.muscle-select');
            if (data.muscleGroup) {
                muscleSelect.value = data.muscleGroup;
            }
            
            // Auto-fill equipment
            const equipmentInput = row.querySelector('.eq-name');
            if (data.equipment) {
                equipmentInput.value = data.equipment;
            }
            
            // Hide dropdown
            element.closest('.suggestions-dropdown').classList.add('hidden');
            currentHighlightedIndex = -1;
        }

        // Equipment Search
        function showEquipmentSuggestions(input) {
            const query = input.value.toLowerCase().trim();
            const dropdown = input.nextElementSibling;
            
            if (query.length < 1) {
                dropdown.classList.add('hidden');
                currentHighlightedIndex = -1;
                return;
            }
            
            const matches = equipmentDB
                .filter(name => name.toLowerCase().includes(query))
                .sort((a, b) => {
                    const aStarts = a.toLowerCase().startsWith(query);
                    const bStarts = b.toLowerCase().startsWith(query);
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    return a.localeCompare(b);
                })
                .slice(0, 8);
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No equipment found matching "' + input.value + '"</div>';
                dropdown.classList.remove('hidden');
                currentHighlightedIndex = -1;
                return;
            }
            
            let html = '<div class="search-hint">Equipment suggestions</div>';
            matches.forEach((name, index) => {
                html += `
                    <div class="suggestion-item" data-equipment="${name}" data-index="${index}"
                         onclick="selectEquipment(this, '${name}')">
                        <div style="color: #60a5fa; font-weight: 500;">${name}</div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
            currentHighlightedIndex = -1;
        }

        function selectEquipment(element, equipmentName) {
            const input = element.closest('.input-container').querySelector('.eq-name');
            input.value = equipmentName;
            element.closest('.suggestions-dropdown').classList.add('hidden');
            currentHighlightedIndex = -1;
        }

        // Keyboard Navigation
        function handleSuggestionKeydown(event, input) {
            const dropdown = input.nextElementSibling;
            if (dropdown.classList.contains('hidden')) return;
            
            const items = dropdown.querySelectorAll('.suggestion-item[data-index]');
            if (items.length === 0) return;
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    currentHighlightedIndex = Math.min(currentHighlightedIndex + 1, items.length - 1);
                    updateHighlight(items);
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    currentHighlightedIndex = Math.max(currentHighlightedIndex - 1, -1);
                    updateHighlight(items);
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    if (currentHighlightedIndex >= 0 && items[currentHighlightedIndex]) {
                        const item = items[currentHighlightedIndex];
                        const exerciseName = item.dataset.exercise;
                        const equipmentName = item.dataset.equipment;
                        
                        if (exerciseName) {
                            selectExercise(item, exerciseName);
                        } else if (equipmentName) {
                            selectEquipment(item, equipmentName);
                        }
                    }
                    break;
                    
                case 'Escape':
                    dropdown.classList.add('hidden');
                    currentHighlightedIndex = -1;
                    break;
            }
        }

        function updateHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === currentHighlightedIndex);
            });
            
            // Scroll highlighted item into view
            if (currentHighlightedIndex >= 0 && items[currentHighlightedIndex]) {
                items[currentHighlightedIndex].scrollIntoView({
                    block: 'nearest',
                    behavior: 'smooth'
                });
            }
        }

        function saveWorkout() {
            const name = document.getElementById('workoutName').value.trim();
            if (!name) {
                alert('Enter workout name');
                return;
            }
            
            const exercises = [];
            document.querySelectorAll('#exercisesList .exercise-row').forEach(row => {
                const exName = row.querySelector('.ex-name').value.trim();
                const muscle = row.querySelector('.muscle-select').value;
                const equipment = row.querySelector('.eq-name').value.trim();
                
                if (exName && muscle) {
                    exercises.push({ name: exName, muscle, equipment });
                }
            });
            
            if (!exercises.length) {
                alert('Add at least one exercise');
                return;
            }
            
            const id = editingWorkoutId || Date.now().toString();
            appData.workouts[id] = { name, exercises };
            saveData();
            
            hideWorkoutForm();
            showWorkoutsList();
            alert(editingWorkoutId ? 'Workout updated!' : 'Workout created!');
        }

        function showWorkoutsList() {
            const container = document.getElementById('workoutsList');
            const workouts = Object.entries(appData.workouts || {});
            
            if (!workouts.length) {
                container.innerHTML = '<p>No workouts yet</p>';
                return;
            }
            
            let html = '<h3 style="color: #10b981; margin-top: 20px;">Your Workouts</h3>';
            workouts.forEach(([id, w]) => {
                html += `
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #10b981;">${w.name}</div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">
                                    ${w.exercises.map(e => e.name).join(', ')}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="action-btn primary" onclick="showWorkoutForm('${id}')">Edit</button>
                                <button class="action-btn danger" onclick="deleteWorkout('${id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function deleteWorkout(id) {
            if (confirm('Delete this workout?')) {
                delete appData.workouts[id];
                saveData();
                showWorkoutsList();
            }
        }

        function showHistory() {
            const container = document.getElementById('historyContent');
            const history = Object.entries(appData.history || {})
                .sort((a, b) => new Date(b[0]) - new Date(a[0]))
                .slice(0, 20);
            
            if (!history.length) {
                container.innerHTML = '<p>No completed workouts yet</p>';
                return;
            }
            
            container.innerHTML = history.map(([key, w]) => `
                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-weight: 600; color: #10b981;">${w.name}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">
                        ${new Date(w.completed).toLocaleDateString()} at ${new Date(w.completed).toLocaleTimeString()}
                    </div>
                    ${w.bodyWeight ? `<div style="font-size: 0.9rem;">Body weight: ${w.bodyWeight} lbs</div>` : ''}
                </div>
            `).join('');
        }

        function showSettings() {
            document.getElementById('settingsContent').innerHTML = `
                <h3 style="color: #10b981;">Database Testing</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="action-btn primary" onclick="testDatabaseLoading()">Test Load Databases</button>
                    <button class="action-btn" onclick="showDatabaseDetails()">Show Database Info</button>
                </div>
                
                <h3 style="color: #10b981;">Body Weight</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="number" id="bw" placeholder="Weight (lbs)" class="exercise-input" 
                           style="max-width: 150px;" value="${appData.settings?.bodyWeight || ''}">
                    <button class="action-btn success" onclick="saveBW()">Save</button>
                </div>
                
                <h3 style="color: #10b981;">GitHub Sync</h3>
                <input type="password" id="ghToken" placeholder="GitHub token" class="exercise-input" 
                       style="margin-bottom: 10px;" value="${githubConfig.token || ''}">
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="action-btn success" onclick="setupGH()">Setup</button>
                    <button class="action-btn primary" onclick="syncGH()">Sync</button>
                </div>
                
                <h3 style="color: #10b981;">Data</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" onclick="exportData()">Export</button>
                    <button class="action-btn danger" onclick="clearAll()">Clear All</button>
                </div>
                
                <div id="databaseStatus" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <h4 style="color: #10b981; margin-bottom: 10px;">Database Status</h4>
                    <div style="font-size: 0.9rem;">
                        <div>🏋️ Exercises: ${Object.keys(exerciseDB).length} loaded</div>
                        <div>⚙️ Equipment: ${equipmentDB.length} items loaded</div>
                    </div>
                </div>
            `;
        }

        async function testDatabaseLoading() {
            document.getElementById('databaseStatus').innerHTML = `
                <h4 style="color: #10b981; margin-bottom: 10px;">Database Loading Test</h4>
                <div style="font-size: 0.9rem;">Loading...</div>
            `;
            
            await loadDatabases();
            
            document.getElementById('databaseStatus').innerHTML = `
                <h4 style="color: #10b981; margin-bottom: 10px;">Database Status (After Test)</h4>
                <div style="font-size: 0.9rem;">
                    <div>🏋️ Exercises: ${Object.keys(exerciseDB).length} loaded</div>
                    <div>⚙️ Equipment: ${equipmentDB.length} items loaded</div>
                    <div style="margin-top: 10px;">Check browser console for detailed logs</div>
                </div>
            `;
        }

        function showDatabaseDetails() {
            const exerciseNames = Object.keys(exerciseDB).slice(0, 10);
            const equipmentNames = equipmentDB.slice(0, 10);
            
            alert(`Database Details:

EXERCISES (showing first 10 of ${Object.keys(exerciseDB).length}):
${exerciseNames.join('\n')}

EQUIPMENT (showing first 10 of ${equipmentDB.length}):
${equipmentNames.join('\n')}

Check browser console for full details.`);
            
            console.log('Full exercise database:', exerciseDB);
            console.log('Full equipment database:', equipmentDB);
        }

        function saveBW() {
            if (!appData.settings) appData.settings = {};
            appData.settings.bodyWeight = document.getElementById('bw').value;
            saveData();
            alert('Saved!');
        }

        async function setupGH() {
            const token = document.getElementById('ghToken').value;
            if (!token) return;
            
            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (res.ok) {
                    const user = await res.json();
                    githubConfig = { token, username: user.login };
                    localStorage.setItem('jimTrackerGH', JSON.stringify(githubConfig));
                    alert(`Connected as ${user.login}`);
                    syncGH();
                }
            } catch (e) {
                alert('Setup failed');
            }
        }

        async function syncGH() {
            if (!githubConfig.token) {
                alert('Setup GitHub first');
                return;
            }
            
            const gistData = {
                description: "Jim Tracker Backup",
                public: false,
                files: {
                    "jim-tracker-data.json": {
                        content: JSON.stringify(appData, null, 2)
                    }
                }
            };
            
            try {
                const url = githubConfig.gistId ? 
                    `https://api.github.com/gists/${githubConfig.gistId}` : 
                    'https://api.github.com/gists';
                    
                const res = await fetch(url, {
                    method: githubConfig.gistId ? 'PATCH' : 'POST',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(gistData)
                });
                
                if (res.ok) {
                    const result = await res.json();
                    githubConfig.gistId = result.id;
                    localStorage.setItem('jimTrackerGH', JSON.stringify(githubConfig));
                    alert('Synced!');
                }
            } catch (e) {
                alert('Sync failed');
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'jim-tracker-backup.json';
            a.click();
        }

        function clearAll() {
            if (confirm('Delete ALL data?')) {
                appData = { workouts: {}, history: {}, active: {}, attendance: {}, settings: {} };
                saveData();
                location.reload();
            }
        }

        // Hide dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-container')) {
                document.querySelectorAll('.suggestions-dropdown').forEach(d => {
                    d.classList.add('hidden');
                });
                currentHighlightedIndex = -1;
            }
        });

        // Start
        init();
    </script>
</body>
</html>
